# 弹幕池的有关定义及数据结构

## 定义

### 弹幕

| 名称     | 英文名       | 解释                             |
| :------- | :----------- | :------------------------------- |
| 时间轴   | Timeline     | 多媒体文件的一个连贯的时间片段。 |
| 弹幕     | Danmaku      | 评论，一般包含时间轴和渲染位置。 |
| 弹幕池   | Danmaku Pool | 弹幕的数组，其中的元素只增不减。 |

###  Kademlia

| 名称     | 英文名       | 解释                             |
| :------- | :----------- | :------------------------------- |
| 节点     | Node         | 对等网络中支持路由查询的客户端。 |
| 友元     | Peer         | 持有资源哈希所对应仓库的客户端。 |
| 资源哈希 | Info Hash    | 由弹幕池绑定的文件所生成的SHA1。 |

### 数据结构

| 名称     | 英文名       | 解释                             |
| :------- | :----------- | :------------------------------- |
| 仓库     | Repository   | 以SHA1散列表形式来储存的弹幕池。 |
| 文档     | Document     | 散列表中的一个键值对，储存弹幕。 |
| 更新     | Commit       | 当前散列表经排序的全部键的SHA1。 |

## 存储

### 分布式弹幕的特性：

1. 只增不减：提交的文档只能做插入和查询，不能修改或删除。表合并不需要比对。
2. 时间主键：主键不包含时间成分，而代以哈希。这是出于时间粒度、准确性、多客户端的冲突问题的考虑（尽管这些问题可以克服）。
3. 最终一致性：
  - 一条弹幕经过足够长的时间，可以从在线时间足够长的客户端发送。
  - 一条弹幕经过足够长的时间，可以被在线时间足够长的客户端获取。
  - 当前的所有弹幕经过足够长的时间，都将被始终在线的客户端获取。
  - 过去的所有弹幕早于足够长的时间，都已被始终在线的客户端获取。

### NOSQL存储

1. 文档存储了弹幕：值为经过封装的弹幕，键为值的SHA1。
2. 仓库存储弹幕池：
  - 属于同一弹幕池的所有弹幕，作为文档存储在同一仓库中，仓库名为弹幕池的资源哈希。
  - 文档应按照键来排序。一次合并应按照键的差异执行一次插入，一次插入可以插入多个值。
  - 每次插入操作应当在日志中记录插入的文档的键和插入完成时的更新的值。
  - 插入记录应当连续，如果抛弃某时刻之前的日志，应记录该时刻全部的键。
3. 数据库存有多个仓库。

Proposal_0004 by Schezuk on 2015.04.28
